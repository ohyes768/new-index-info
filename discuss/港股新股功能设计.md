# 港股新股发行信息获取系统 - 实现计划

## 需求概述

在现有 A 股新股系统基础上，新增港股新股发行信息获取功能：
- 输出格式与 A 股保持一致（Markdown 格式）
- 可被 n8n 读取并推送
- 使用免费的 API 或网页抓取方案
- 保持代码简洁，易于维护

## 技术方案

### 数据源选择

**主方案：新浪财经港股新股网页抓取** ⭐
- URL: http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php
- 优点：完全免费、无需认证、接口稳定
- 包含字段：股票代码、名称、申购日期、上市日期、发行价、中签率

**备用方案：东方财富网数据抓取**
- URL: https://data.eastmoney.com/xg/
- 优点：数据更新及时、结构化良好

### 实现架构

#### 方案一：独立港股模块（推荐）⭐

创建独立的港股新股程序，与 A 股并行：

```
deploy/
├── models.py              # 通用数据模型
├── services.py            # A 股服务模块
├── main_simple.py         # A 股主入口
├── hk_services.py         # 港股服务模块（新增）
├── hk_main.py            # 港股主入口（新增）
└── requirements.txt       # 依赖更新
```

**优点**：
- 代码隔离，互不影响
- 可以独立运行和调试
- 便于后续扩展（美股等其他市场）

#### 方案二：合并到现有模块

在现有 services.py 中添加港股数据源：

```python
class DataFetcher:
    def __init__(self, market='CN'):  # CN=A股, HK=港股
        self.market = market

    def fetch_new_stocks(self):
        if self.market == 'CN':
            return self._fetch_cn_stocks()
        elif self.market == 'HK':
            return self._fetch_hk_stocks()
```

**优点**：
- 代码复用
- 统一的接口

**缺点**：
- 代码耦合
- 单个文件可能超过 500 行

### ✅ 用户确认：独立模块方案

根据用户需求确认：
- **集成方式**：独立模块（hk_main.py），与 A 股分开运行
- **数据源**：新浪财经网页抓取（完全免费）
- **数据字段**：基础信息 + 申购信息 + 公司信息

## 实现步骤

### 第一阶段：数据获取模块

#### 1. 创建港股数据模型（hk_models.py）

```python
@dataclass
class HKNewStockInfo:
    """港股新股信息模型"""
    stock_code: str              # 股票代码（如 "00700.HK"）
    stock_name: str              # 股票名称
    stock_name_en: str           # 英文名称
    issue_date: Optional[datetime]    # 申购日期
    listing_date: Optional[datetime]  # 上市日期
    offer_price: Optional[float]      # 发行价格（港元）
    offer_volume: Optional[float]     # 发行数量（股）
    subscription_limit: Optional[float] # 申购上限
    allotment_ratio: Optional[str]     # 中签率
    market: str = "港股"          # 市场
    industry: str = ""            # 所属行业
    company_profile: str = ""     # 公司简介
```

#### 2. 实现港股数据获取（hk_services.py）

**主要函数**：

```python
import requests
from bs4 import BeautifulSoup

class HKDataFetcher:
    """港股新股数据获取器"""

    def fetch_hk_new_stocks(self) -> List[HKNewStockInfo]:
        """获取港股新股数据（主方法）"""

    def _scrape_sina_ipo(self) -> List[HKNewStockInfo]:
        """从新浪财经抓取港股新股数据"""
        url = "http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php"
        # 使用 requests + BeautifulSoup 解析

    def _scrape_eastmoney_ipo(self) -> List[HKNewStockInfo]:
        """从东方财富网抓取港股新股数据（备用）"""
        url = "https://data.eastmoney.com/xg/"
```

**依赖包**：
```bash
pip install requests beautifulsoup4 lxml
```

### 第二阶段：数据处理和格式化

#### 1. 数据处理（复用现有逻辑）

```python
class HKDataProcessor:
    """港股新股数据处理器"""

    def filter_future_stocks(self, stocks: List[HKNewStockInfo], days=10):
        """筛选未来 N 天内的新股"""

    def validate_data(self, stocks: List[HKNewStockInfo]):
        """验证数据完整性"""
```

#### 2. Markdown 格式化（复用现有格式）

```python
class HKMarkdownFormatter:
    """港股新股 Markdown 格式化器"""

    def format_new_stocks(self, stocks: List[HKNewStockInfo]) -> str:
        """格式化为 Markdown"""
```

**输出格式示例**：
```markdown
# 港股新股发行信息

**生成时间**: 2026-01-07 10:00:00
**新股数量**: 2 只

---

## 2026-01-10

### 腾讯音乐（01698.HK）

| 项目 | 信息 |
|------|------|
| **申购代码** | 01698.HK |
| **申购日期** | 2026-01-05 |
| **发行价格** | 250.00港元 |
| **发行数量** | 1000万股 |
| **申购上限** | 50万股 |
| **中签率** | 10.50% |
| **上市日期** | 2026-01-10 |
| **上市地点** | 港交所-主板 |

**公司简介**:
腾讯音乐娱乐集团...
```

### 第三阶段：主入口

#### 创建港股主入口（hk_main.py）

```python
from services import HKDataFetcher, HKDataProcessor, HKMarkdownFormatter, setup_logger

def main():
    """港股新股主函数"""
    logger = setup_logger()

    try:
        # 1. 获取数据
        fetcher = HKDataFetcher()
        stocks = fetcher.fetch_hk_new_stocks()

        # 2. 处理数据
        processor = HKDataProcessor(future_days=10)
        valid_stocks = processor.validate_data(stocks)
        future_stocks = processor.filter_future_stocks(valid_stocks)

        # 3. 格式化输出
        formatter = HKMarkdownFormatter()
        markdown = formatter.format_new_stocks(future_stocks)

        # 4. 输出到控制台
        print(markdown)

        logger.info(f"港股新股获取完成，共 {len(future_stocks)} 只")
    except Exception as e:
        logger.error(f"港股新股获取失败: {e}", exc_info=True)
        raise

if __name__ == "__main__":
    main()
```

### 第四阶段：集成和脚本

#### 1. 更新依赖（requirements.txt）

```
akshare>=1.17.80
pandas>=2.3.0
requests>=2.31.0
beautifulsoup4>=4.12.0
lxml>=5.0.0
```

#### 2. 创建港股启动脚本

**hk_run.bat**:
```batch
@echo off
cd /d "%~dp0"

if not exist ".venv" (
    echo Error: Virtual environment not found
    pause
    exit /b 1
)

cd deploy
echo Starting HK New Stock System...
"..\.venv\Scripts\python.exe" hk_main.py %*

pause
```

**hk_run.sh**:
```bash
#!/bin/bash
cd "$(dirname "$0")"

if [ ! -d ".venv" ]; then
    echo "错误: 虚拟环境不存在"
    exit 1
fi

cd deploy
echo "启动港股新股系统..."
../.venv/bin/python hk_main.py "$@"
```

## n8n 集成

在 n8n 中创建两个独立的 "Execute Command" 节点：

**节点 1：A 股新股**
```
cd /path/to/new-index-info/deploy && ../.venv/bin/python main_simple.py
```

**节点 2：港股新股**
```
cd /path/to/new-index-info/deploy && ../.venv/bin/python hk_main.py
```

可以分别推送到不同的钉钉群或合并到一个群。

## 关键文件清单

需要创建/修改的文件：

1. **deploy/hk_models.py** - 港股数据模型（新建）
2. **deploy/hk_services.py** - 港股服务模块（新建，约 400 行）
3. **deploy/hk_main.py** - 港股主入口（新建，约 70 行）
4. **deploy/requirements.txt** - 更新依赖
5. **scripts/hk_run.bat** - 港股启动脚本（新建）
6. **scripts/hk_run.sh** - 港股启动脚本（新建）
7. **README.md** - 添加港股功能说明

## 数据抓取技术细节

### 新浪财经港股新股页面分析

**URL**: http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php

**页面结构**：
- 使用表格展示新股列表
- 每行包含一只新股的信息
- 字段包括：代码、名称、申购日期、上市日期、发行价等

**可用字段**：
- ✅ 股票代码、名称（中文/英文）
- ✅ 申购日期、上市日期
- ✅ 发行价格、发行数量
- ✅ 申购上限、中签率
- ❌ 所属行业（不包含）
- ❌ 公司简介（不包含）

### 公司信息补充方案

由于新浪财经页面不包含行业和公司简介，需要从其他数据源获取：

**方案 A：东方财富港股详情页**（推荐）
```python
def _enrich_company_info(self, stock_code: str) -> dict:
    """补充公司行业和简介信息"""
    # 方案1：从东方财富港股详情页抓取
    url = f"https://quote.eastmoney.com/hk/{stock_code}.html"
    # 解析页面获取行业、公司简介等信息
```

**方案 B：雅虎财经 API**
```python
def _get_yahoo_finance_info(self, stock_code: str) -> dict:
    """从雅虎财经获取港股基本信息"""
    import yfinance as yf
    # 移除 .HK 后缀，转换为雅虎格式
    symbol = stock_code.replace('.HK', '').rjust(5, '0') + '.HK'
    stock = yf.Ticker(symbol)
    info = stock.info
    return {
        'industry': info.get('industry'),
        'business_summary': info.get('longBusinessSummary')
    }
```

**方案 C：暂时留空**
- 优先完成基础功能
- 公司信息字段留空，显示"暂无信息"
- 后续根据需求补充

**推荐实施顺序**：
1. **第一阶段**：实现基础信息和申购信息抓取
2. **第二阶段**：测试东方财富网页抓取获取行业信息
3. **第三阶段**：评估是否需要公司简介（可能需要额外数据源）

**注意**：港股公司信息获取比 A 股复杂，可能需要多个数据源组合。

**解析策略**：
```python
def _scrape_sina_ipo(self):
    url = "http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php"
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }

    response = requests.get(url, headers=headers, timeout=10)
    response.encoding = 'gbk'  # 新浪使用 gbk 编码

    soup = BeautifulSoup(response.text, 'lxml')
    table = soup.find('table', {'id': 'IPOList'})

    # 解析表格行
    for row in table.find_all('tr')[1:]:  # 跳过表头
        cols = row.find_all('td')
        # 提取数据并转换为 HKNewStockInfo
```

### 数据字段映射（新浪财经）

| 页面字段 | HKNewStockInfo 字段 | 备注 |
|---------|-------------------|------|
| 股票代码 | stock_code | 格式：00700.HK |
| 股票名称 | stock_name | 中文名称 |
| 英文名称 | stock_name_en | 英文名称 |
| 申购日期 | issue_date | YYYY-MM-DD |
| 上市日期 | listing_date | YYYY-MM-DD |
| 发行价 | offer_price | 港元 |
| 发行数量 | offer_volume | 股数 |
| 申购上限 | subscription_limit | 股数 |
| 中签率 | allotment_ratio | 百分比 |
| - | industry | 需从其他源获取 |
| - | company_profile | 需从其他源获取 |

### 错误处理

```python
def fetch_hk_new_stocks(self) -> List[HKNewStockInfo]:
    """获取港股新股数据（支持多数据源）"""
    try:
        # 方案1：新浪财经
        return self._scrape_sina_ipo()
    except Exception as e:
        logger.warning(f"新浪财经数据获取失败: {e}")

    try:
        # 方案2：东方财富（备用）
        return self._scrape_eastmoney_ipo()
    except Exception as e:
        logger.error(f"东方财富数据获取失败: {e}")

    return []  # 全部失败返回空列表
```

## 风险和注意事项

### 1. 反爬机制
- **风险**：网站可能有反爬限制
- **对策**：
  - 设置合理的请求间隔（2-5秒）
  - 使用随机 User-Agent
  - 控制请求频率

### 2. 数据格式变化
- **风险**：网页结构可能变化导致解析失败
- **对策**：
  - 实现多数据源备用
  - 添加详细的异常日志
  - 定期检查数据获取状态

### 3. 数据准确性
- **风险**：网页数据可能有延迟或错误
- **对策**：
  - 交叉验证多个数据源
  - 添加数据合理性检查
  - 在日志中记录数据来源

## 测试计划

### 1. 单元测试
```python
# 测试数据获取
def test_fetch_hk_stocks():
    fetcher = HKDataFetcher()
    stocks = fetcher.fetch_hk_new_stocks()
    assert len(stocks) > 0

# 测试数据处理
def test_processor():
    processor = HKDataProcessor(future_days=10)
    filtered = processor.filter_future_stocks(stocks)
    assert all(stock.listing_date <= today + timedelta(days=10))

# 测试格式化
def test_formatter():
    formatter = HKMarkdownFormatter()
    markdown = formatter.format_new_stocks(stocks)
    assert "# 港股新股发行信息" in markdown
```

### 2. 集成测试
- 运行完整流程
- 验证输出格式
- 测试 n8n 集成

## 部署说明

### 快速开始
```bash
# 1. 安装新依赖
pip install -r deploy/requirements.txt

# 2. 运行港股新股
cd deploy
python hk_main.py

# 或使用脚本
scripts/hk_run.bat  # Windows
bash scripts/hk_run.sh  # Linux/Mac
```

### n8n 配置
创建两个独立的定时任务：
- A 股新股：每天早上 9:00
- 港股新股：每天早上 9:00（港股时间）

## 后续扩展

1. **美股新股**：类似架构，添加美股数据源
2. **统一接口**：创建统一的主入口，支持多市场
3. **数据存储**：添加数据库存储历史数据
4. **Web 界面**：开发简单的 Web 查询界面

## 预估工作量

- 数据抓取模块：2-3 小时
- 数据处理和格式化：1-2 小时
- 主入口和脚本：30 分钟
- 测试和调试：1-2 小时
- 文档更新：30 分钟

**总计**：5-8 小时
