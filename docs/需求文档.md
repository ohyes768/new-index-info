# 新股发行信息获取系统 - 需求文档

**版本**: v2.0.0
**最后更新**: 2026-01-29
**状态**: ✅ 已实现（命令行工具 + FastAPI 微服务）

---

## 变更记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-29 | v2.0.0 | 新增 FastAPI 微服务架构、Docker 部署、API 接口 |
| 2026-01-07 | v1.3.0 | 添加港股详情页补充、A股公司简介表格化显示 |
| 2026-01-07 | v1.2.0 | 优化申购日期显示、新增分类展示和未来14天新股筛选 |
| 2026-01-07 | v1.1.0 | 新增港股新股功能，重构项目结构 |
| 2025-12-XX | v1.0.0 | 初始版本，实现A股新股功能 |

---

## 功能变更记录

### 2026-01-29 v2.0.0 - FastAPI 微服务架构

#### 变更类型：架构升级 + 新功能

#### 影响范围：
- 整体系统架构
- 部署方式
- API 接口
- 集成方式

#### 变更内容：

1. **FastAPI 微服务架构** ✅ [新增]
   - 采用 Gateway + 后端服务微服务架构
   - Gateway 服务（端口 8000）- 统一入口和路由转发
   - A股服务（端口 8001）- A股新股信息查询
   - 港股服务（端口 8002）- 港股新股信息查询
   - 服务间通过 HTTP 通信，支持独立部署和扩展

2. **RESTful API 接口** ✅ [新增]
   - `GET /health` - Gateway 健康检查
   - `GET /api/a-stock` - 获取 A股新股信息
   - `GET /api/hk-stock` - 获取港股新股信息
   - 统一 JSON 响应格式
   - 支持标准的 HTTP 状态码

3. **Docker 容器化部署** ✅ [新增]
   - 每个服务独立 Docker 镜像
   - Docker Compose 一键部署
   - 支持环境变量配置
   - 服务网络隔离

4. **部署和运维脚本** ✅ [新增]
   - `scripts/build.sh` - 构建所有镜像
   - `scripts/start.sh` - 启动所有服务
   - `scripts/stop.sh` - 停止所有服务
   - 完善的日志输出和错误处理

5. **保留命令行工具** ✅
   - 完整保留原有 deploy/ 目录的命令行工具
   - 支持两种使用方式：命令行工具 + FastAPI API
   - 用户可根据场景选择合适的方式

#### 用户体验变化：
- **命令行工具方式**：适合个人使用或简单场景，保持原有使用方式
- **FastAPI API 方式**：适合集成到自动化工具（n8n 2.x）或需要长期运行的服务
- **Docker 部署**：一键部署，无需手动安装 Python 依赖
- **更好的可扩展性**：可通过增加服务实例水平扩展
- **更灵活的集成**：支持任何支持 HTTP 的工具和平台

#### API 响应格式示例：
```json
{
  "success": true,
  "market": "A股",
  "data": "# A股新股发行信息\n...",
  "subscribable_count": 2,
  "future_count": 5
}
```

---

### 2026-01-07 v1.3.0 - 详情补充与格式统一

#### 变更类型：功能增强 + 格式优化

#### 影响范围：
- 港股数据获取模块
- A股和港股格式化输出模块
- A股数据获取逻辑

#### 变更内容：

1. **港股详情页补充功能** ✅ [新增]
   - 在港股列表获取后，自动访问每只股票的详情页
   - 补充"所属行业"和"公司简介"信息
   - 新增 `_fetch_stock_detail()` 方法获取单个股票详情
   - 新增 `enrich_stocks_detail()` 方法批量补充详情信息
   - 请求间隔保持5秒，避免被新浪财经封禁

2. **A股公司简介数据源优化** ✅
   - 移除"机构简介"字段的使用
   - 直接使用"主营业务"作为公司简介
   - 简化数据获取逻辑，提高可靠性
   - 主营业务信息更准确描述公司核心业务

3. **格式化输出统一** ✅
   - 将A股公司简介从表格外的独立段落改为表格内的行
   - 港股和A股都使用相同的表格结构显示公司简介
   - 提升信息展示的统一性和可读性

4. **日志输出优化** ✅
   - 将所有 logger 调用改为 print 输出到 stderr
   - 核心结果以 JSON 格式输出到 stdout
   - 便于 n8n 等自动化工具解析

#### 用户体验变化：
- 港股新股信息现在包含完整的所属行业和公司简介
- A股和港股输出格式完全统一，表格结构一致
- 公司简介信息更准确可靠，直接来源于主营业务
- 所有调试信息输出到 stderr，核心数据为 JSON 格式

---

### 2026-01-07 v1.2.0 - 申购日期优化与分类展示

#### 变更类型：功能优化 + 新增功能

#### 影响范围：
- A股和港股筛选模块
- A股和港股格式化输出模块
- 主程序调用逻辑

#### 变更内容：

1. **申购日期显示优化** ✅
   - 单个日期也显示为范围格式（如 "2026-01-06至2026-01-06"）
   - A股和港股统一使用范围格式显示
   - 提升视觉统一性，方便用户理解

2. **筛选逻辑调整** ✅
   - 从"未来10天内的新股"改为"当前可申购的新股"
   - 筛选条件：申购日期范围内包含今天的新股（`start_date <= today <= end_date`）
   - 更符合用户实际需求，聚焦当前可操作的机会

3. **分类展示功能** ✅ [新增]
   - **第一部分**：当前可申购的新股
   - **第二部分**：未来14天即将开放申购的新股
   - 帮助投资者提前规划，不错过未来机会
   - A股和港股同步支持分类输出

4. **API优化** ✅
   - 移除 `DataProcessor(future_days=10)` 的 `future_days` 参数
   - 新增 `filter_subscribable_stocks()` 方法
   - 新增 `filter_future_unopened_stocks(future_days=14)` 方法
   - 更新 `format_new_stocks()` 支持两个参数进行分类展示

#### 用户体验变化：
- 用户可以快速识别当前可申购的新股，不再需要从未来10天的列表中筛选
- 用户可以提前了解未来14天即将开放申购的新股，做好资金准备
- 申购日期显示更清晰统一，避免混淆

---

## 1. 项目概述

### 1.1 项目背景
开发一个自动化工具，帮助投资者及时获取**沪深两市和港股市场**的新股发行信息，避免错过打新机会。

### 1.2 项目目标
自动获取**当前可申购的**和**未来14天即将开放申购的****沪深两市和港股**的新股发行信息，并以 Markdown 格式分类输出到控制台，供 n8n 等自动化工具读取和推送，实现信息获取的自动化。

**v1.2.0 更新**：
- 筛选逻辑聚焦"当前可申购"，而非简单的时间范围
- 分类展示帮助用户快速定位可操作机会
- 提前14天预告，便于资金规划

### 1.3 支持的市场
- ✅ **A股市场**：上海证券交易所、深圳证券交易所、北京证券交易所
- ✅ **港股市场**：香港证券交易所主板

### 1.4 使用方式
项目支持两种使用方式：

#### 方式一：命令行工具（v1.x）
- 适合个人使用或简单场景
- 手动触发执行
- 输出 Markdown 格式到控制台
- 便于 n8n 1.x 的 Execute Command 节点集成

#### 方式二：FastAPI RESTful API（v2.0 新增）✅
- 适合自动化工具集成（n8n 2.x）
- 长期运行的 HTTP 服务
- 返回 JSON 格式数据
- 支持 Docker Compose 一键部署
- 更好的可扩展性和稳定性

## 2. 功能需求

### 2.1 核心功能

#### 2.1.0 FastAPI 微服务架构 ✅ [v2.0.0新增]

**Gateway 服务（端口 8000）**：
- 统一入口，对外暴露 RESTful API
- 路由转发：将请求转发到对应的后端服务
- 健康检查：`GET /health` 端点
- 错误处理：统一的错误响应格式
- 日志记录：记录所有请求和响应

**A-Stock Service（端口 8001）**：
- 封装 A股新股查询逻辑
- 提供 `/api/stocks` 端点（内部）
- 复用现有 DataFetcher、DataProcessor、MarkdownFormatter
- 独立部署和扩展

**HK-Stock Service（端口 8002）**：
- 封装港股新股查询逻辑
- 提供 `/api/stocks` 端点（内部）
- 复用现有 HKDataFetcher、HKDataProcessor、HKMarkdownFormatter
- 独立部署和扩展

**API 接口规范**：
- `GET /health` - Gateway 健康检查
- `GET /api/a-stock` - 获取 A股新股信息
- `GET /api/hk-stock` - 获取港股新股信息
- 统一响应格式：
  ```json
  {
    "success": true/false,
    "market": "A股/港股",
    "data": "Markdown 格式的新股信息",
    "subscribable_count": N,
    "future_count": M,
    "error": "错误信息（仅在失败时）"
  }
  ```

**Docker 部署**：
- 每个服务独立 Docker 镜像
- Docker Compose 一键启动
- 支持环境变量配置
- 服务网络隔离
- 日志持久化

### 2.1.1 A股数据获取（命令行工具版本）
- **数据源**: akshare（免费财经数据接口）
- **获取内容**: 沪深两市未来10天内的新股发行信息
- **更新频率**: 手动触发执行

#### 2.1.2 港股数据获取（命令行工具版本）✅ [v1.1.0新增]
- **数据源**: 新浪财经网页抓取（完全免费）
- **URL**: http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php
- **获取内容**: 港股市场未来10天内的新股发行信息
- **更新频率**: 手动触发执行
- **反爬策略**: 5秒请求间隔、随机User-Agent、GBK编码处理

#### 2.1.3 A股数据展示（命令行工具版本）
需要展示以下信息：

**基本信息**:
- 股票代码
- 股票名称
- 申购代码
- **申购日期** ✅ 新增

**发行相关**:
- 发行价格
- 发行数量
- 申购上限
- 中签率

**上市相关**:
- 上市日期
- **上市地点** ✅ 更新为详细分类（上海-主板、上海-科创板、深圳-主板、深圳-创业板、北交所）

**公司信息**:
- **所属行业** ✅ 已实现
- **公司简介** ✅ 已实现

#### 2.1.4 港股数据展示（命令行工具版本）✅ [v1.1.0新增]
需要展示以下信息：

**基本信息**:
- 股票代码
- 股票名称（中英文）
- 申购日期
- 上市日期

**发行相关**:
- 招股价区间
- 发售股数
- 集资额（港元）
- 认购倍数

**上市相关**:
- 上市地点：港交所

#### 2.1.5 输出展示（命令行工具版本）
- **输出方式**: Markdown 格式打印到控制台（标准输出）
- **输出内容**: 包含所有新股信息的完整报告
- **集成方式**: 可被 n8n 等自动化工具读取并推送到钉钉等平台

### 2.2 非功能需求

#### 2.2.1 性能要求
- 数据获取时间: < 10秒
- 补充详细信息时间: < 5秒（仅对筛选后的新股）
- 总体执行时间: < 15秒
- **性能优化**: 先筛选后补充信息，避免对所有股票调用API ✅

#### 2.2.2 可靠性要求
- 网络异常时自动重试（最多3次）
- 数据异常时优雅降级
- 详细的日志记录

#### 2.2.3 可维护性要求
- 代码符合规范：单个文件不超过300行
- 清晰的模块划分和文档
- 统一的日志输出

## 3. 技术选型

### 3.1 开发语言
- **Python 3.10+**: 简洁高效，丰富的数据分析库

### 3.2 命令行工具版本依赖

#### A股模块
- **akshare**: 免费财经数据接口
- **pandas**: 数据处理

#### 港股模块 ✅ [v1.1.0新增]
- **requests**: HTTP请求库
- **beautifulsoup4**: HTML解析库
- **lxml**: XML/HTML解析引擎

### 3.3 FastAPI 微服务版本依赖 ✅ [v2.0.0新增]

#### Web 框架
- **FastAPI (0.104.1+)**: 现代化的 Web 框架，自动生成 API 文档
- **uvicorn**: ASGI 服务器，支持异步处理
- **httpx**: 异步 HTTP 客户端

#### 容器化部署
- **Docker**: 容器化技术
- **Docker Compose (3.8+)**: 服务编排

#### 命令行工具依赖
- 复用命令行版本的所有依赖（akshare, pandas, requests, beautifulsoup4, lxml）

### 3.4 包管理
- **uv**: 现代化的Python包管理工具
- **虚拟环境**: .venv

### 3.5 自动化集成
- **n8n 1.x**: 通过 Execute Command 节点调用命令行工具
- **n8n 2.x**: 通过 HTTP Request 节点调用 FastAPI 接口 ✅ [v2.0.0新增]
- **其他工具**: 任何支持 HTTP 的工具和平台 ✅ [v2.0.0新增]

## 4. 业务场景

### 4.1 典型使用场景

#### 场景一：命令行工具方式（v1.x）
1. n8n 定时触发 Python 脚本
2. 系统自动获取未来10天的新股信息
3. 生成格式化的 Markdown 报告并输出到控制台
4. n8n 读取输出内容
5. n8n 推送到钉钉群
6. 投资者在钉钉群查看新股信息

#### 场景二：FastAPI API 方式（v2.0）✅ [新增]
1. Docker Compose 启动 FastAPI 微服务
2. n8n 定时发送 HTTP 请求到 Gateway
3. Gateway 转发请求到对应的后端服务
4. 后端服务获取新股信息并格式化
5. 返回 JSON 格式数据给 n8n
6. n8n 解析 JSON 并推送到钉钉群
7. 投资者在钉钉群查看新股信息

### 4.2 特殊场景处理
- **无新股时**: 显示"暂无新股"的友好提示
- **数据异常**: 记录详细日志，跳过异常数据
- **输出格式**: 确保 Markdown 格式正确，便于 n8n 解析

## 5. 用户故事

### 5.1 作为投资者
> 我希望能够及时了解未来有哪些新股可以申购，这样我就不会错过打新的机会。

### 5.2 作为投资者
> 我希望看到新股的详细信息（价格、行业、简介等），这样我可以判断是否值得申购。

### 5.3 作为投资者
> 我希望信息能自动推送到我常用的群聊工具，这样我就不需要主动去查看了。

## 6. 验收标准

### 6.1 功能验收

#### A股功能验收
- ✅ 成功获取未来10天的新股数据
- ✅ 数据包含完整信息（基本信息、发行、上市、公司）
  - 基本信息：股票代码、股票名称、申购代码、申购日期
  - 发行相关：发行价格、发行数量、申购上限、中签率
  - 上市相关：上市日期、详细市场信息（主板/科创板/创业板/北交所）
  - 公司信息：所属行业、公司简介
- ✅ 输出格式为清晰的 Markdown
- ✅ Markdown 正确输出到控制台（可被 n8n 读取）

#### 港股功能验收 ✅ [v1.1.0新增]
- ✅ 成功获取港股新股数据（从新浪财经抓取）
- ✅ 数据包含完整信息
  - 基本信息：股票代码、股票名称（中英文）
  - 发行相关：招股价区间、发售股数、集资额、认购倍数
  - 上市相关：申购日期、上市日期、上市地点（港交所）
- ✅ 网页抓取稳定性（编码处理、反爬策略）
- ✅ 输出格式为清晰的 Markdown
- ✅ Markdown 正确输出到控制台（可被 n8n 读取）

### 6.2 质量验收
- ✅ 日志正确输出到 logs/ 目录
- ✅ 代码符合架构规范（文件行数、目录结构）
- ✅ 可以通过 scripts/run.bat 和 scripts/hk_run.bat 正常运行
- ✅ 异常情况有合理的处理和提示
- ✅ 项目结构清晰（Amarket/ 和 Hmarket/ 分离）✅ [v1.1.0更新]

### 6.3 用户体验验收
- ✅ 操作简单，一键执行
- ✅ 输出信息清晰易读
- ✅ 输出格式符合 n8n 解析要求
- ✅ A股和港股可分别查询 ✅ [v1.1.0新增]

## 7. 约束条件

### 7.1 技术约束
- 必须使用 Python 开发
- 推荐使用 uv 进行包管理（也可使用 pip）
- 虚拟环境目录名必须是 .venv

### 7.2 规范约束
- 主程序文件不超过 500 行
- 使用强类型数据结构（dataclass）
- 脚本必须放在 scripts/ 目录
- 日志必须输出到 logs/ 目录
- 主程序放在 deploy/ 目录

### 7.3 安全约束
- 不涉及敏感信息存储（由 n8n 端管理 webhook）
- 配置简单，无需额外的环境变量

## 8. 里程碑

### 阶段一：基础框架 ✅
- 需求分析 ✅
- 设计方案 ✅

### 阶段二：核心开发 ✅
- 项目初始化 ✅
- 基础设施层实现 ✅
- 核心服务层实现 ✅

### 阶段三：集成测试 ✅
- 主入口和脚本实现 ✅
- 功能测试 ✅
- 异常处理测试 ✅

### 阶段四：文档完善 ✅
- README.md 编写 ✅
- 使用说明 ✅
- 部署指南 ✅
- 项目结构优化（简化为 3 个文件）✅

### 阶段五：项目维护 ✅
- 移除冗余的分层架构代码 ✅
- 保留 deploy/ 目录作为主程序 ✅
- 更新所有项目文档 ✅

### 阶段六：港股功能扩展 ✅ [v1.1.0新增]
- 港股新股调研 ✅
- 数据源选择（新浪财经网页抓取）✅
- 独立港股模块实现 ✅
- 网页抓取功能开发 ✅
- 数据解析和格式化 ✅
- 港股启动脚本创建 ✅
- 项目结构重组（Amarket/ 和 Hmarket/）✅
- 功能测试和验证 ✅

### 阶段七：筛选逻辑优化与分类展示 ✅ [v1.2.0新增]
- 筛选逻辑重构 ✅
- 数据模型更新（新增日期范围字段）✅
- 分类展示功能实现 ✅
- 日期显示优化 ✅
- API接口优化 ✅
- A股和港股同步更新 ✅
- 功能测试和验证 ✅
- 所有文档更新到 v1.2.0 ✅

### 阶段八：FastAPI 微服务架构 ✅ [v2.0.0新增]
- 微服务架构设计 ✅
- Gateway 服务实现 ✅
- A股服务实现 ✅
- 港股服务实现 ✅
- Docker 镜像构建 ✅
- Docker Compose 配置 ✅
- 部署脚本编写 ✅
- API 接口测试 ✅
- README 更新 ✅
- FastAPI 部署文档编写 ✅
- 所有文档更新到 v2.0.0 ✅
