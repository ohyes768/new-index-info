# 新股发行信息获取系统 - 技术设计文档

**版本**: v1.3.0
**最后更新**: 2026-01-07
**状态**: ✅ 已实现（A股 + 港股，详情补充 + 格式统一）

---

## 变更记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-07 | v1.3.0 | 添加港股详情页补充、A股公司简介表格化和数据源优化 |
| 2026-01-07 | v1.2.0 | 优化申购日期显示、新增分类展示和筛选逻辑重构 |
| 2026-01-07 | v1.1.0 | 新增港股新股模块，重构项目架构 |
| 2025-12-XX | v1.0.0 | 初始版本，A股新股系统 |

---

## 技术实现更新

### v1.3.0 - 详情补充与格式统一（2026-01-07）

#### 港股详情页补充功能

**新增方法**：

```python
def _fetch_stock_detail(self, stock_code: str) -> tuple:
    """获取单个股票的详情页信息

    访问新浪财经港股IPO详情页，提取板块和公司简介信息

    Returns:
        tuple: (板块, 公司简介)
    """
    url = f"http://vip.stock.finance.sina.com.cn/q/view/hk_IPOProfile.php?symbol={stock_code}"

    # 1. 请求频率限制（5秒间隔）
    # 2. 发送HTTP请求，处理GBK编码
    # 3. 解析HTML，查找板块和公司简介字段
    # 4. 返回提取的信息
```

```python
def enrich_stocks_detail(self, stocks: List[HKNewStockInfo]) -> List[HKNewStockInfo]:
    """批量补充股票的详情信息

    对每只股票调用详情页API，补充板块和公司简介

    Args:
        stocks: 港股新股列表

    Returns:
        补充了详情信息的股票列表
    """
    for stock in stocks:
        industry, company_intro = self._fetch_stock_detail(stock.stock_code)
        stock.industry = industry
        stock.company_intro = company_intro
```

**技术要点**：
- 详情页URL: `http://vip.stock.finance.sina.com.cn/q/view/hk_IPOProfile.php?symbol={股票代码}`
- 编码处理: GBK
- 请求间隔: 5秒（与列表页保持一致）
- HTML解析: BeautifulSoup + lxml

**性能影响**：
- 每只股票额外请求1次详情页
- 包含频率限制，N只股票约需 5*N 秒
- 建议只对筛选后的少量股票（当前可申购 + 未来14天）补充详情

#### A股公司简介数据源优化

**修改前**：
```python
# 优先使用机构简介，否则使用主营业务
intro = df_profile.iloc[0].get("机构简介", "")
if not intro or pd.isna(intro):
    intro = df_profile.iloc[0].get("主营业务", "")
```

**修改后**：
```python
# 直接使用主营业务
intro = df_profile.iloc[0].get("主营业务", "")
```

**优化理由**：
1. 主营业务字段更完整、更可靠
2. 直接描述公司核心业务，更符合"公司简介"需求
3. 简化逻辑，减少判断条件

#### 格式化输出统一

**A股格式变更**：
- 将公司简介从表格外的独立段落移入表格内
- 与港股保持一致的表格结构

**代码变更**：
```python
# 修改前
lines.append("")
# 公司简介
if stock.company_intro:
    lines.append("**公司简介**:")
    lines.append(stock.company_intro)
    lines.append("")

# 修改后
# 公司简介（如果有）
if stock.company_intro:
    lines.append(f"| **公司简介** | {stock.company_intro} |")

lines.append("")
```

#### 日志输出优化

**变更内容**：
- 将所有 `logger.*()` 调用改为 `print(..., file=sys.stderr)`
- 核心结果以 JSON 格式输出到 stdout
- 统一A股和港股的日志输出方式

**代码示例**：
```python
# 修改前
self.logger.info("开始获取港股新股数据...")

# 修改后
print("INFO: 开始获取港股新股数据...", file=sys.stderr)

# 核心输出
result = {
    "success": True,
    "market": "港股",
    "data": markdown,
    "subscribable_count": len(subscribable_stocks),
    "future_count": len(future_stocks)
}
print(json.dumps(result, ensure_ascii=False))
```

**优势**：
- 便于 n8n 等工具直接解析 JSON 输出
- 调试日志不会干扰核心数据
- 统一的输出格式

---

## 1. 系统架构

---

## 1. 系统架构

### 1.1 整体架构

系统采用**模块化设计**，A 股和港股分别实现独立的模块：

```
new-index-info/
├── deploy/
│   ├── Amarket/              # A股市场模块
│   │   ├── models.py         # A股数据模型
│   │   ├── services.py       # A股服务（数据获取、处理、格式化）
│   │   └── main_simple.py    # A股主入口
│   ├── Hmarket/              # 港股市场模块 [v1.1.0新增]
│   │   ├── hk_models.py      # 港股数据模型
│   │   ├── hk_services.py    # 港股服务（网页抓取、处理、格式化）
│   │   └── hk_main.py        # 港股主入口
│   └── requirements.txt      # 依赖包列表
├── scripts/                  # 启动脚本
│   ├── run.bat/sh            # A股启动脚本
│   └── hk_run.bat/sh         # 港股启动脚本 [v1.1.0新增]
└── logs/                     # 日志目录
```

### 1.2 架构设计原则

- **模块独立性**: A股和港股完全独立，互不影响
- **代码复用**: 相同功能在不同模块中保持一致的实现方式
- **可扩展性**: 便于未来添加美股等其他市场
- **可维护性**: 清晰的目录结构，易于定位和修改

---

## 2. A股模块设计

### 2.1 数据模型（models.py）

```python
@dataclass
class NewStockInfo:
    """A股新股信息模型"""
    stock_code: str              # 股票代码
    stock_name: str              # 股票名称
    subscription_code: str       # 申购代码
    subscription_date: Optional[datetime]  # 申购日期
    issue_price: Optional[float]        # 发行价格
    issue_amount: Optional[float]        # 发行数量（万股）
    subscription_limit: Optional[float]  # 申购上限（万股）
    success_rate: Optional[str]          # 中签率
    listing_date: Optional[datetime]     # 上市日期
    market: str = ""              # 市场分类
    industry: str = ""            # 所属行业
    company_intro: str = ""       # 公司简介
```

### 2.2 核心服务（services.py）

#### 2.2.1 数据获取器（DataFetcher）

```python
class DataFetcher:
    """A股新股数据获取器"""

    def fetch_new_stocks(self) -> List[NewStockInfo]:
        """获取A股新股数据（主方法）"""
        # 1. 从 akshare 获取基础数据
        # 2. 筛选未来10天的新股
        # 3. 对每只股票补充详细信息
        # 4. 返回完整的股票列表
```

**数据源**: akshare `stock_new_a_spot_em()` 接口

**获取流程**:
1. 调用 akshare 获取基础新股列表
2. 筛选上市日期在未来10天内的股票
3. 对筛选后的股票补充详细信息（行业、公司简介）
4. 返回完整的股票信息列表

#### 2.2.2 数据处理器（DataProcessor）

```python
class DataProcessor:
    """A股新股数据处理器"""

    def filter_future_stocks(self, stocks: List[NewStockInfo], days: int = 10):
        """筛选未来N天内的新股"""

    def validate_data(self, stocks: List[NewStockInfo]):
        """验证数据完整性"""
```

#### 2.2.3 格式化器（MarkdownFormatter）

```python
class MarkdownFormatter:
    """Markdown 格式化器"""

    def format_new_stocks(self, stocks: List[NewStockInfo]) -> str:
        """格式化为 Markdown"""
```

**输出格式**:
```markdown
# A股新股发行信息

**生成时间**: 2026-01-07 09:00:00
**新股数量**: 3 只

---

## 2026-01-10

### 股票名称（股票代码）

| 项目 | 信息 |
|------|------|
| **申购代码** | XXXXXX |
| **申购日期** | 2026-01-05 |
| **发行价格** | 25.50元 |
| **发行数量** | 5000万股 |
| **申购上限** | 50万股 |
| **中签率** | 0.05% |
| **上市日期** | 2026-01-10 |
| **上市地点** | 上海-科创板 |
| **所属行业** | 软件和信息技术服务业 |

**公司简介**:
...
```

### 2.3 主入口（main_simple.py）

```python
def main():
    """A股新股主函数"""
    # 1. 初始化日志
    logger = setup_logger()

    # 2. 获取数据
    fetcher = DataFetcher()
    stocks = fetcher.fetch_new_stocks()

    # 3. 处理数据
    processor = DataProcessor(future_days=10)
    future_stocks = processor.filter_future_stocks(stocks)

    # 4. 格式化输出
    formatter = MarkdownFormatter()
    markdown = formatter.format_new_stocks(future_stocks)
    print(markdown)
```

---

## 3. 港股模块设计 [v1.1.0新增]

### 3.1 数据模型（hk_models.py）

```python
@dataclass
class HKNewStockInfo:
    """港股新股信息模型"""
    stock_code: str                  # 股票代码（如 "00700"）
    stock_name: str                  # 股票名称（中文）
    stock_name_en: Optional[str]     # 股票英文名称
    offer_price_range: Optional[str]     # 招股价区间
    raised_amount: Optional[str]         # 集资额（港元）
    offer_shares: Optional[str]          # 发售股数
    subscription_ratio: Optional[str]    # 认购倍数
    subscription_date: Optional[datetime]  # 申购日期
    listing_date: Optional[datetime]      # 上市日期
    market: str = "港股"              # 市场
    industry: str = ""                # 所属行业
    company_intro: str = ""           # 公司简介
```

### 3.2 核心服务（hk_services.py）

#### 3.2.1 数据获取器（HKDataFetcher）

```python
class HKDataFetcher:
    """港股新股数据获取器（网页抓取）"""

    def __init__(self, timeout: int = 10, min_interval: int = 5):
        """初始化获取器

        Args:
            timeout: 请求超时时间（秒）
            min_interval: 最小请求间隔（秒），防止被封禁
        """
        self.base_url = "http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php"
        self.min_interval = min_interval  # 5秒间隔防止封禁
        self.user_agents = [...]  # 随机User-Agent池

    def fetch_hk_new_stocks(self) -> List[HKNewStockInfo]:
        """获取港股新股数据（主方法）"""
        # 1. 请求频率限制
        # 2. 发送HTTP请求
        # 3. 解析HTML表格
        # 4. 返回股票列表
```

**数据源**: 新浪财经港股IPO页面

**技术实现**:
- HTTP库: `requests`
- HTML解析: `BeautifulSoup` + `lxml`
- 编码处理: GBK（新浪财经使用GBK编码）
- 反爬策略:
  - 5秒请求间隔（防止IP被封禁）
  - 随机User-Agent轮换
  - 超时控制（10秒）

**HTML解析逻辑**:
```python
def _parse_table(self, table) -> List[HKNewStockInfo]:
    """解析新浪财经HTML表格"""
    # 1. 查找tbody中的所有行
    # 2. 跳过表头
    # 3. 解析每行数据：
    #    - col 0: 股票代码
    #    - col 1: 股票名称
    #    - col 2: 招股价
    #    - col 4: 募资额（百万港元）
    #    - col 5: 招股日期
    #    - col 6: 上市日期
    # 4. 单位转换：百万港元 → 港元
    # 5. 返回股票列表
```

#### 3.2.2 数据处理器（HKDataProcessor）

```python
class HKDataProcessor:
    """港股新股数据处理器"""

    def filter_future_stocks(self, stocks: List[HKNewStockInfo], days: int = 10):
        """筛选未来N天内的新股"""

    def validate_data(self, stocks: List[HKNewStockInfo]):
        """验证数据完整性"""
```

#### 3.2.3 格式化器（HKMarkdownFormatter）

```python
class HKMarkdownFormatter:
    """港股 Markdown 格式化器"""

    def format_new_stocks(self, stocks: List[HKNewStockInfo]) -> str:
        """格式化为 Markdown"""
```

**输出格式**:
```markdown
# 港股新股发行信息

**生成时间**: 2026-01-07 09:00:00
**新股数量**: 3 只

---

## 2026-01-10

### 股票名称（股票代码）

| 项目 | 信息 |
|------|------|
| **股票代码** | 00700 |
| **申购日期** | 2026-01-05 |
| **上市日期** | 2026-01-10 |
| **招股价** | 250.00-280.00港元 |
| **发售股数** | 1,000万股 |
| **集资额** | 25.00亿港元 |
| **上市地点** | 港交所 |
```

### 3.3 主入口（hk_main.py）

```python
def main():
    """港股新股主函数"""
    # 1. 初始化日志
    logger = setup_logger()

    # 2. 获取数据（网页抓取）
    fetcher = HKDataFetcher()
    stocks = fetcher.fetch_hk_new_stocks()

    # 3. 处理数据
    processor = HKDataProcessor(future_days=10)
    future_stocks = processor.filter_future_stocks(stocks)

    # 4. 格式化输出
    formatter = HKMarkdownFormatter()
    markdown = formatter.format_new_stocks(future_stocks)
    print(markdown)
```

---

## 4. 技术栈

### 4.1 开发语言
- **Python 3.10+**

### 4.2 A股模块依赖
```txt
akshare>=1.17.80    # A股数据接口
pandas>=2.3.0       # 数据处理
```

### 4.3 港股模块依赖 [v1.1.0新增]
```txt
requests>=2.31.0        # HTTP请求
beautifulsoup4>=4.12.0  # HTML解析
lxml>=5.0.0             # XML/HTML解析引擎
```

### 4.4 开发工具
- **uv**: Python包管理工具
- **Git**: 版本控制
- **VS Code**: 代码编辑器

---

## 5. 关键技术实现

### 5.1 A股数据获取

**接口**: `akshare.stock_new_a_spot_em()`

**特点**:
- 免费、无需认证
- 数据结构化良好
- 包含基本信息，但不包含行业和公司简介

**补充信息方案**:
- 调用 `akshare.stock_individual_info_em()`
- 获取行业分类和公司简介
- 仅对筛选后的股票调用（性能优化）

### 5.2 港股网页抓取

**目标URL**: `http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php`

**实现要点**:

1. **编码处理**
   ```python
   response.encoding = 'gbk'  # 新浪使用GBK编码
   ```

2. **表格解析**
   ```python
   # 查找第二个表格（第一个是导航菜单）
   tables = soup.find_all('table')
   table = tables[1]  # 使用第二个表格

   # 只解析tbody中的行
   for row in table.find_all('tr'):
       parent_tbody = row.find_parent('tbody')
       if not parent_tbody:
           continue  # 跳过thead和tfoot
   ```

3. **单位转换**
   ```python
   # 原始数据单位：百万港元
   amount_million = float(raised_amount_raw)
   amount_hkd = amount_million * 1000000  # 转换为港元
   ```

4. **反爬策略**
   ```python
   def _rate_limit(self):
       """请求频率限制"""
       elapsed = time.time() - self.last_request_time
       if elapsed < self.min_interval:
           sleep_time = self.min_interval - elapsed + random.uniform(0.5, 1.5)
           time.sleep(sleep_time)

   def _get_headers(self) -> dict:
       """获取随机请求头"""
       return {
           'User-Agent': random.choice(self.user_agents),
           'Accept': 'text/html,application/xhtml+xml',
           'Accept-Language': 'zh-CN,zh;q=0.9',
       }
   ```

### 5.3 日志系统

**日志配置**:
```python
def setup_logger(name: str = "new-stock") -> logging.Logger:
    """设置日志记录器"""
    # 1. 创建logs目录
    # 2. 设置日志格式
    # 3. 添加控制台处理器
    # 4. 添加文件处理器（按日期分割）
    # 5. 返回logger实例
```

**日志输出**:
- 控制台：INFO级别，带颜色
- 文件：`logs/new-stock-YYYY-MM-DD.log`（A股）
- 文件：`logs/hk-new-stock-YYYY-MM-DD.log`（港股）

### 5.4 Markdown格式化

**设计原则**:
- 统一的格式风格
- 按日期分组
- 使用表格展示关键信息
- 便于n8n解析和钉钉展示

**格式化流程**:
1. 生成标题和元数据
2. 按上市日期分组
3. 对每只股票生成详细信息表格
4. 返回完整Markdown字符串

---

## 6. 错误处理

### 6.1 网络异常

**A股模块**:
```python
try:
    data = akshare.stock_new_a_spot_em()
except Exception as e:
    logger.error(f"获取A股数据失败: {e}")
    return []
```

**港股模块**:
```python
try:
    response = requests.get(url, timeout=10)
except requests.exceptions.Timeout:
    logger.error("请求超时")
    return []
except requests.exceptions.RequestException as e:
    logger.error(f"网络请求失败: {e}")
    return []
```

### 6.2 数据异常

```python
def validate_data(self, stocks: List[NewStockInfo]):
    """验证数据完整性"""
    valid_stocks = []
    for stock in stocks:
        # 1. 验证必需字段
        if not stock.stock_code or not stock.stock_name:
            logger.warning(f"股票代码或名称为空，跳过")
            continue

        # 2. 验证日期字段
        if not stock.listing_date:
            logger.warning(f"上市日期为空，跳过")
            continue

        valid_stocks.append(stock)
    return valid_stocks
```

### 6.3 网页结构变化

**港股模块应对策略**:
```python
def fetch_hk_new_stocks(self) -> List[HKNewStockInfo]:
    try:
        # 主方案：新浪财经
        return self._parse_table(table)
    except Exception as e:
        logger.error(f"解析失败: {e}")
        # 备用方案：可以从其他数据源获取
        return []
```

---

## 7. 性能优化

### 7.1 A股模块

**优化策略**: 先筛选后补充信息

```python
# 1. 获取基础数据
all_stocks = fetch_from_akshare()

# 2. 筛选未来10天
future_stocks = filter_by_date(all_stocks, days=10)

# 3. 仅对筛选后的股票补充详细信息
for stock in future_stocks:
    stock.industry = get_industry(stock.stock_code)
    stock.company_intro = get_company_intro(stock.stock_code)
```

**效果**:
- 原方案：对所有股票调用API（~100次调用）
- 优化后：仅对筛选后的股票调用API（~3-10次调用）
- 性能提升：10-30倍

### 7.2 港股模块

**优化策略**:
- 请求频率限制（5秒间隔），避免IP被封禁
- 超时控制（10秒），避免长时间等待
- 随机User-Agent，降低被识别为爬虫的风险

---

## 8. 安全考虑

### 8.1 数据安全
- 不涉及用户隐私数据
- 不存储敏感信息
- 仅从公开数据源获取信息

### 8.2 网络安全
- 使用HTTPS（如果数据源支持）
- 设置请求超时，避免长时间挂起
- 限制请求频率，避免对数据源造成压力

### 8.3 代码安全
- 输入验证：对获取的数据进行验证
- 异常处理：所有网络请求都有异常处理
- 日志记录：记录所有关键操作和错误

---

## 9. 部署和运维

### 9.1 环境要求
- Python 3.10+
- 虚拟环境：`.venv`
- 操作系统：Windows/Linux/Mac

### 9.2 安装步骤

```bash
# 1. 创建虚拟环境
uv venv

# 2. 激活虚拟环境
# Windows
.venv\Scripts\activate
# Linux/Mac
source .venv/bin/activate

# 3. 安装依赖
uv pip install -r deploy/requirements.txt
```

### 9.3 运行方式

**A股新股**:
```bash
# Windows
scripts\run.bat

# Linux/Mac
./scripts/run.sh

# 或直接运行
cd deploy && ../.venv/bin/python main_simple.py
```

**港股新股** [v1.1.0新增]:
```bash
# Windows
scripts\hk_run.bat

# Linux/Mac
./scripts/hk_run.sh

# 或直接运行
cd deploy && ../.venv/bin/python hk_main.py
```

### 9.4 n8n集成

在n8n中创建两个独立的"Execute Command"节点：

**节点1：A股新股**
```bash
cd /path/to/new-index-info/deploy && ../.venv/bin/python main_simple.py
```

**节点2：港股新股** [v1.1.0新增]
```bash
cd /path/to/new-index-info/deploy && ../.venv/bin/python hk_main.py
```

---

## 10. 测试

### 10.1 单元测试

**A股模块**:
```python
def test_fetch_a_stocks():
    fetcher = DataFetcher()
    stocks = fetcher.fetch_new_stocks()
    assert len(stocks) > 0
    assert all(stock.listing_date for stock in stocks)
```

**港股模块** [v1.1.0新增]:
```python
def test_fetch_hk_stocks():
    fetcher = HKDataFetcher()
    stocks = fetcher.fetch_hk_new_stocks()
    assert len(stocks) > 0
    assert all(stock.listing_date for stock in stocks)
```

### 10.2 集成测试

**测试场景**:
1. 正常情况：成功获取并输出数据
2. 无新股：显示友好提示
3. 网络异常：优雅降级
4. 数据异常：记录日志并跳过

### 10.3 性能测试

**A股模块**:
- 数据获取时间：< 10秒
- 总体执行时间：< 15秒

**港股模块** [v1.1.0新增]:
- 网页抓取时间：< 5秒
- 总体执行时间：< 10秒

---

## 11. 后续优化方向

### 11.1 功能扩展
- [ ] 添加美股新股功能
- [ ] 统一多市场接口
- [ ] 添加数据存储功能（数据库）
- [ ] 添加Web查询界面

### 11.2 性能优化
- [ ] 使用异步IO提升抓取速度
- [ ] 添加缓存机制，减少重复请求
- [ ] 优化HTML解析性能

### 11.3 稳定性提升
- [ ] 添加更多备用数据源
- [ ] 实现自动重试机制
- [ ] 添加数据质量监控

### 11.4 用户体验
- [ ] 添加配置文件支持
- [ ] 支持自定义输出格式
- [ ] 添加命令行参数支持

---

## 12. 附录

### 12.1 相关文档
- [产品需求文档(PRD)](./需求文档.md)
- [数据字典](./数据字典.md)
- [API接口文档](./API接口文档.md) - 待创建
- [文档索引](./文档索引.md) - 待创建

### 12.2 外部参考
- [akshare官方文档](https://akshare.akfamily.xyz/)
- [新浪财经港股IPO页面](http://vip.stock.finance.sina.com.cn/q/view/hk_IPOList.php)
- [BeautifulSoup文档](https://www.crummy.com/software/BeautifulSoup/bs4/doc/)

### 12.3 版本历史
详见文档顶部的"变更记录"。
